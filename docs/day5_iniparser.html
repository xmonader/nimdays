<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link href="stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/softcover.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/custom.css" media="screen" rel="stylesheet" type="text/css" />
    
    <title>nimdays</title>
    
      <script type="text/x-mathjax-config">
              MathJax.Hub.Config({
        "HTML-CSS": {
          availableFonts: ["TeX"],
        },
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js", "color.js"],
          equationNumbers: {
            autoNumber: "AMS",
            formatNumber: function (n) { return "5" + '.' + n }
          },
          Macros: {
            PolyTeX:    "Poly{\\TeX}",
            PolyTeXnic: "Poly{\\TeX}nic",
            "softcover": "\\texttt{softcover}",
"unitvec": ["{\\hat #1}", 1]
          }
        },
        showProcessingMessages: false,
        messageStyle: "none",
        imageFont: null,
        "AssistiveMML": { disabled: true }
      });

        if (/PhantomJS/.test(window.navigator.userAgent)) {
          MathJax.Hub.Queue([alert, 'MathJax Done']);
        }
      </script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG"></script>
    
  </head>
  <body>
    
    <div id="book">
      <div id="cid13" data-tralics-id="cid13" class="chapter" data-number="5" data-chapter="day5_iniparser"><h1><a href="day5_iniparser.html#cid13" class="heading hyperref"><span class="number">Chapter 5 </span>Day 5: Creating INI Parser</a></h1>
<p class="noindent">this is a pure <a href="https://en.wikipedia.org/wiki/Ini_file" target="_blank" rel="noopener">Ini</a> parser for nim</p>
<blockquote class="quotation"><p class="quote">Nim has advanced <a href="https://nim-lang.org/docs/parsecfg.html" target="_blank" rel="noopener">parsecfg</a></p>
</blockquote></div>
<div id="cid14" data-tralics-id="cid14" class="section" data-number="5.1"><h2><a href="day5_iniparser.html#cid14" class="heading hyperref"><span class="number">5.1 </span>What to expect ?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">sample1</span> <span class="o">=</span> <span class="s">"""</span>

<span class="s">[general]</span>
<span class="s">appname = configparser</span>
<span class="s">version = 0.1</span>

<span class="s">[author]</span>
<span class="s">name = xmonader</span>
<span class="s">email = notxmonader@gmail.com</span>


<span class="s">"""</span>

<span class="kd">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">parseIni</span><span class="p">(</span><span class="n">sample1</span><span class="p">)</span>

<span class="c"># doAssert(d.sectionsCount() == 2)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"general"</span><span class="p">,</span> <span class="s">"appname"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"configparser"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"general"</span><span class="p">,</span><span class="s">"version"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"0.1"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"xmonader"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"email"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"notxmonader@gmail.com"</span><span class="p">)</span>

<span class="n">d</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"email"</span><span class="p">,</span> <span class="s">"alsonotxmonader@gmail.com"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"email"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"alsonotxmonader@gmail.com"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasSection</span><span class="p">(</span><span class="s">"general"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasSection</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">d</span><span class="p">.</span><span class="n">deleteProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">false</span><span class="p">)</span>

<span class="n">echo</span> <span class="n">d</span><span class="p">.</span><span class="n">toIniString</span><span class="p">()</span>
<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">getSection</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span>
<span class="n">echo</span> <span class="o">$</span><span class="n">s</span>
</pre></div></div>
</div>
<div id="cid15" data-tralics-id="cid15" class="section" data-number="5.2"><h2><a href="day5_iniparser.html#cid15" class="heading hyperref"><span class="number">5.2 </span>Implementation</a></h2>
<p class="noindent">You can certainly use regular expressions, like pythons configparser, but we will go for a simpler approach here, also we want to keep it pure so we don’t depend on <code>pcre</code></p>
<div id="uid48" data-tralics-id="uid48" class="subsection" data-number="5.2.1"><h3><a href="day5_iniparser.html#uid48" class="heading hyperref"><span class="number">5.2.1 </span>Ini sample</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">[general]</span>
<span class="na">appname</span> <span class="o">=</span> <span class="s">configparser</span>
<span class="na">version</span> <span class="o">=</span> <span class="s">0.1</span>

<span class="k">[author]</span>
<span class="na">name</span> <span class="o">=</span> <span class="s">xmonader</span>
<span class="na">email</span> <span class="o">=</span> <span class="s">notxmonader@gmail.com</span>
</pre></div></div>
<p>Ini file consists of one or more sections and each section consists of one or more key value pairs separated by <code>=</code></p>
</div>
<div id="uid49" data-tralics-id="uid49" class="subsection" data-number="5.2.2"><h3><a href="day5_iniparser.html#uid49" class="heading hyperref"><span class="number">5.2.2 </span>Define your data types</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strutils</span>
</pre></div></div>
<p>We will use tables extensively
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Section</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span>
</pre></div></div>
<p><code>Section</code> type contains <code>properties</code> table represents key value pairs</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">setProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Section</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">this</span><span class="p">.</span><span class="n">properties</span><span class="o">[</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div></div>
<p>To set property in the underlying <code>properties</code> table</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">newSection</span><span class="o">*</span><span class="p">()</span> <span class="p">:</span> <span class="n">Section</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Section</span><span class="p">()</span>
    <span class="n">s</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div></div>
<p>To create new Section object</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Section</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="k">return</span> <span class="s">"&lt;Section"</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">properties</span> <span class="o">&amp;</span> <span class="s">" &gt;"</span>
</pre></div></div>
<p>Simple <code>toString</code> proc using <code>$</code> operator
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Ini</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
    <span class="n">sections</span><span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">Section</span><span class="o">]</span>
</pre></div></div>
<p><code>Ini</code> type represents the whole document and contains a table <code>section</code> from <code>sectionName</code> to <code>Section</code> object.</p>
<div class="code"><div class="highlight"><pre><span></span>proc newIni*() : Ini = 
    var ini = Ini()
    ini.sections = initTable[string, Section]()
    return ini
</pre></div></div>
<p>To create new Ini object
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> 
    <span class="k">return</span> <span class="s">"&lt;Ini "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">sections</span> <span class="o">&amp;</span> <span class="s">" &gt;"</span>
</pre></div></div>
<p>define friendly <code>toString</code> proc using <code>$</code> operator</p>
</div>
<div id="uid50" data-tralics-id="uid50" class="subsection" data-number="5.2.3"><h3><a href="day5_iniparser.html#uid50" class="heading hyperref"><span class="number">5.2.3 </span>Define API</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>proc setSection*(this: Ini, name: string, section: Section) =
    this.sections[name] = section

proc getSection*(this: Ini, name: string): Section =
    return this.sections.getOrDefault(name)

proc hasSection*(this: Ini, name: string): bool =
    return this.sections.contains(name)

proc deleteSection*(this: Ini, name:string) =
    this.sections.del(name)

proc sectionsCount*(this: Ini) : int = 
    echo $this.sections
    return len(this.sections)
</pre></div></div>
<p>Some helper procs around Ini objects for manipulating sections.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">hasProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="kt">bool</span><span class="o">=</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">)</span> <span class="ow">and</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">setProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span><span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">echo</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">sections</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">):</span>
        <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">getProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>


<span class="k">proc </span><span class="nf">deleteProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">)</span> <span class="ow">and</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">del</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>
</pre></div></div>
<p>More helpers around properties in the section objects managed by <code>Ini</code> object</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">toIniString</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sep</span><span class="p">:</span><span class="kt">char</span><span class="o">=</span><span class="sc">'='</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">output</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">sectName</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">&amp;=</span> <span class="s">"["</span> <span class="o">&amp;</span> <span class="n">sectName</span> <span class="o">&amp;</span> <span class="s">"]"</span> <span class="o">&amp;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">section</span><span class="p">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">&amp;=</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="n">sep</span> <span class="o">&amp;</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> 
        <span class="n">output</span> <span class="o">&amp;=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div></div>
<p>Simple proc <code>toIniString</code> to convert the nim structures into Ini text string</p>
</div>
<div id="uid51" data-tralics-id="uid51" class="subsection" data-number="5.2.4"><h3><a href="day5_iniparser.html#uid51" class="heading hyperref"><span class="number">5.2.4 </span>Parse!</a></h3>
<p class="noindent">OK, here comes the cool part</p>
<div id="uid52" data-tralics-id="uid52" class="subsubsection" data-number="5.2.4.1"><h4><a href="#uid52" class="heading">Parser states</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">readSection</span><span class="p">,</span> <span class="n">readKV</span>
</pre></div></div>
<p>Here we have two states
- readSection: when we are supposed to extract section name from the current line
- readKV: when we are supposed to read the line in key value pair mode</p>
</div>
<div id="uid53" data-tralics-id="uid53" class="subsubsection" data-number="5.2.4.2"><h4><a href="#uid53" class="heading">ParseIni proc</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">parseIni</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">Ini</span> <span class="o">=</span> 
</pre></div></div>
<p>Here we define a proc <code>parseIni</code> that takes a string <code>s</code> and creates an <code>Ini</code> object</p>
<div class="code"><div class="highlight"><pre><span></span>    <span class="kd">var</span> <span class="n">ini</span> <span class="o">=</span> <span class="n">newIni</span><span class="p">()</span>
    <span class="kd">var</span> <span class="n">state</span><span class="p">:</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="n">readSection</span>
    <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">splitLines</span>
    
    <span class="kd">var</span> <span class="n">currentSectionName</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">var</span> <span class="n">currentSection</span> <span class="o">=</span> <span class="n">newSection</span><span class="p">()</span>
</pre></div></div>
<ul>
<li><code>ini</code> is the object to be returned after parsing
</li>
<li><code>state</code> the current parser state (weather it’s <code>readSection</code> or <code>readKV</code>)
</li>
<li><code>lines</code> input string splitted into lines <code>as we are a lines based parser</code>
</li>
<li><code>currentSectionName</code> to keep track of what section we are currently in
</li>
<li><code>currentSection</code> to populate <code>ini.sections</code> with <code>Section</code> object using <code>setSection</code> proc
</li></ul>
<div class="code"><div class="highlight"><pre><span></span>   <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</pre></div></div>
<p>for each line
</p><div class="code"><div class="highlight"><pre><span></span>         <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">""</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">";"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"#"</span><span class="p">):</span>
            <span class="k">continue</span>
</pre></div></div>
<p>We continue if line is safe to igore <code>empty line</code> or starts with <code>;</code> or <code>#</code></p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"["</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="p">.</span><span class="n">endsWith</span><span class="p">(</span><span class="s">"]"</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">readSection</span>
</pre></div></div>
<p>if line startswith <code>[</code> and ends with <code>]</code> then we set parser state to <code>readSection</code></p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">readSection</span><span class="p">:</span>
            <span class="n">currentSectionName</span> <span class="o">=</span> <span class="n">line</span><span class="o">[</span><span class="mf">1</span><span class="p">..</span><span class="o">&lt;</span><span class="n">line</span><span class="p">.</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
            <span class="n">ini</span><span class="p">.</span><span class="n">setSection</span><span class="p">(</span><span class="n">currentSectionName</span><span class="p">,</span> <span class="n">currentSection</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">readKV</span>
            <span class="k">continue</span>
</pre></div></div>
<p>if parser <code>state</code> is <code>readSection</code>
- extract section name <code>between [ and ]</code>
- add section object to the ini under the current section name
- change <code>state</code> to <code>readKV</code> to read key value pairs
- continue the loop on the nextline as we’re done processing the section name.</p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">readKV</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">({</span><span class="sc">'='</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">let</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">ini</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">currentSectionName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</pre></div></div>
<p>if <code>state</code> is <code>readKV</code>
- extract <code>key</code> and <code>val</code> by splitting the line on <code>=</code>
- <code>setProperty</code> under the <code>currentSectionName</code> using <code>key</code> and <code>val</code>
</p><div class="code"><div class="highlight"><pre><span></span>    <span class="k">return</span> <span class="n">ini</span>
</pre></div></div>
<p>Here we return the populated <code>ini</code> object.</p>
</div></div></div>
    </div>
  </body>
</html>
